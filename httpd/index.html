<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>nerdobd2</title>
  <script language="javascript" type="text/javascript" src="js/jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="js/jquery.flot.min.js"></script>
  <script language="javascript" type="text/javascript" src="js/jquery.flot.threshold.min.js"></script>

  <script language="javascript" type="text/javascript">

    function Graph(Name, Series, Options, Timespan)
    {
        var name;
        var index;
        var timespan;
        
        var options;
        var series;
                
        this.setIndex = function(index)
        {
            this.index = index;
        }
        
        this.getIndex = function()
        {
            return this.index;
        }
        
        this.setTimespan = function(timespan)
        {
            this.timespan = timespan;
        }
        
        this.getTimespan = function()
        {
            return this.timespan;
        }
       
        this.updateOptions = function()
        {                   
            var now = (new Date()).getTime();

            // adjust the xaxis, so graph moves forward
            this.options.xaxis.min = now - this.timespan;
            this.options.xaxis.max = now - 1000;            // prevent small empty gaps at the beginning of the graph
        }
        
        this.appendData = function(data)
        {
            var i;
            var now = (new Date()).getTime();
                    
            // loop reverse, for better performance
            for (i = data.length - 1; i >= 0; i--)
            {
                // after we find the first element that is outdated
                if (data[i][0] <= now - this.timespan)
                {
                    // remove everything up to this element
                    data.splice(0, i);
                    break;
                }
            }

            // prepend new data to series
            this.series.data = data.concat(this.series.data);
            
            this.updateOptions();
            this.plot();
        }
        

        
        this.plot = function()
        {
            $.plot($(this.name), [ this.series ], this.options);
        }
        
        this.construct = function()
        {
            this.name = Name;
            this.series = Series;
            this.options = Options;
            this.timespan = Timespan;
            this.index = 0;
        }

        this.construct();
    } 

  
$(document).ready(function() {

    var ConsumptionGraph = new Graph("#graph_consumption",
                                     { "data": [], "color": "rgb(200, 20, 30)",
                                       "lines": { "fill": false, "steps": true },
                                       "threshold": { "below": 6.0, "color": "rgb(30, 180, 20)" } },
                                     { "series": { "shadowSize": 0 }, 
                                       "yaxis": { "min": 0, "max": "20" }, 
                                       "xaxis": { "min": 0, "max": 0, "mode": "time", "timeformat": "%H:%M" } },
                                     300000);

    var SpeedGraph = new Graph("#graph_speed",
                               { "data": [], "color": "rgb(0, 0, 0)",
                                 "lines": { "fill": true } },    
                               { "series": { "shadowSize": 0 }, 
                                 "yaxis": { "min": 0, "max": "150" }, 
                                 "xaxis": { "min": 0, "max": 0, "mode": "time", "timeformat": "%H:%M" } },
                               1800000);
                               
                               
    function onDataReceived(json) {

        if (json.graph_consumption.index)
            ConsumptionGraph.setIndex(json.graph_consumption.index);
        if (json.graph_speed.index)
            SpeedGraph.setIndex(json.graph_speed.index);

        ConsumptionGraph.appendData(json.graph_consumption.data);
        SpeedGraph.appendData(json.graph_speed.data);
    
        if (json.latest_data.rpm)
            $("#rpm").html(json.latest_data.rpm.toFixed(0) + " rpm");
        if (json.latest_data.speed)
            $("#speed").html(json.latest_data.speed.toFixed(1) + " km/h");
        if (json.latest_data.per_km)
            $("#per_km").html(json.latest_data.per_km.toFixed(2) + " l/km");
        if (json.averages.timespan)
            $("#timespan").html(json.averages.timespan.toFixed(2) + " l/km");
        if (json.averages.total)
            $("#total").html(json.averages.total.toFixed(2) + " l/km");

        setTimeout(getData, 500);
    }


    function getData() {
        $.ajax({
            url: "data.json" + 
                 "?consumption_index=" + ConsumptionGraph.getIndex() +
                 "&consumption_timespan=" + ConsumptionGraph.getTimespan() / 1000 + 
                 "&speed_index=" + SpeedGraph.getIndex() + 
                 "&speed_timespan=" + SpeedGraph.getTimespan() / 1000,
            method: 'GET',
            dataType: 'json',
            success: onDataReceived
        });
    }

    getData();
});    
  </script>

 </head>
  <body>
    <div id="graphs">
      <div id="graph_consumption" style="width:470px;height:150px"></div>
      <div id="graph_speed" style="width:470px;height:150px"></div>
    </div>

    <div id="data" style="position:fixed;top:0px;left:500px;float:right;font-size:48px">
      <div id="rpm"></div>
      <div id="speed"></div>
      <div id="per_km"></div>
      <div id="timespan"></div>
      <div id="timespan_new"></div>
      <div id="total"></div>
      <div id="total_new"></div>      
    </div>
 </body>
</html>

