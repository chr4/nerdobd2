<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>nerdobd2</title>
  <link rel="stylesheet" href="style.css" type="text/css" media="all" />
  <script language="javascript" type="text/javascript" src="js/jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="js/jquery.flot.min.js"></script>
  <script language="javascript" type="text/javascript" src="js/jquery.flot.threshold.min.js"></script>

  <script language="javascript" type="text/javascript">

    function Graph(Name, Series, Options, Timespan)
    {
        var name;
        var index;
        var timespan;

        var options;
        var series;

        this.setIndex = function(newIndex)
        {
            index = newIndex;
        }

        this.getIndex = function()
        {
            return index;
        }

        this.setTimespan = function(newTimespan)
        {
            timespan = newTimespan;
        }

        this.getTimespan = function()
        {
            return timespan;
        }

        this.updateOptions = function()
        {
            var now = (new Date()).getTime();

            // adjust the xaxis, so graph moves forward
            options.xaxis.min = now - timespan;
            options.xaxis.max = now - 1000;            // prevent small empty gaps at the beginning of the graph
        }

        this.appendData = function(data)
        {
            var i;
            var now = (new Date()).getTime();

            // loop reverse, for better performance
            for (i = data.length - 1; i >= 0; i--)
            {
                // after we find the first element that is outdated
                if (data[i][0] <= now - timespan)
                {
                    // remove everything up to this element
                    data.splice(0, i);
                    break;
                }
            }

            // prepend new data to series
            // this.series.data = data.concat(this.series.data);
            series.data = $.merge(series.data, data);

            this.updateOptions();
            this.plot();
        }

        this.update = function()
        {
            // this is out of scope in onDataReceived
            var that = this;

            function onDataReceived(json)
            {
                that.setIndex(json.index);
                that.appendData(json.data);

                // wtf js!
                // update every 1 second on 5min graph, others accordingly
                setTimeout(function() { that.update(); }, timespan / 300);
            }

            $.ajax({
                url: name + ".json" +
                     "?index=" + index +
                     "&timespan=" + timespan / 1000,
                method: 'GET',
                dataType: 'json',
                success: onDataReceived
            });
        }

        this.plot = function()
        {
            $.plot($("#graph-" + name), [ series ], options);
        }

        this.construct = function()
        {
            name = Name;
            series = Series;
            options = Options;
            timespan = Timespan;
            index = 0;

            this.update();
        }

        this.construct();
    }


    function Value(Name, Unit, Accuracy)
    {
        var name;
        var unit;
        var accuracy;

        this.update = function(data)
        {
            // switch to l/h if consumption_per_100km is -1 (means that speed == 0)
            if (name == "consumption_per_100km" && data[name] == -1)
                this.set(data['consumption_per_h'], "l/h");
            else
                this.set(data[name], unit);
        }

        this.set = function(value, theunit)
        {
            $('#' + name).html(value.toFixed(accuracy));

            // set the unit for consumption accordingly
            if (name == "consumption_per_100km")
                $('#' + name + '-unit').html(theunit);
        }

        this.construct = function()
        {
            name = Name;
            unit = Unit;
            accuracy = Accuracy;
        }

        this.construct();
    }


    function Values()
    {
        var elements;

        this.create = function(name, unit, accuracy)
        {
            elements.push(new Value(name, unit, accuracy));
        }

        this.update = function update()
        {
            function onDataReceived(json)
            {
                for (var i = elements.length - 1; i >= 0; i--)
                    elements[i].update(json);

                // wtf js!
                setTimeout(update, 300);
            }

            // return if we don't have any elements yet
            if (elements.length == 0)
            {
                setTimeout(update, 300);
                return;
            }
            else
            {
                $.ajax({
                    url: "data.json",
                    method: 'GET',
                    dataType: 'json',
                    success: onDataReceived
                });
            }
        }

        this.construct = function()
        {
            elements = [];
            setTimeout(this.update, 300);
        }

        this.construct();
    }


$(document).ready(function() {


    // maybe we can put those options somewhere better maintainable
    var ConsumptionGraph = new Graph("consumption",
                                     { "data": [], "color": "rgb(200, 20, 30)",
                                       "lines": { "fill": false, "steps": true },
                                       "threshold": { "below": 6.0, "color": "rgb(30, 180, 20)" } },
                                     { "series": { "shadowSize": 0 },
                                       "yaxis": { "min": 0, "max": "20" },
                                       "xaxis": { "min": 0, "max": 0, "mode": "time", "timeformat": "%H:%M" } },
                                     300000);

    var SpeedGraph = new Graph("speed",
                               { "data": [], "color": "rgb(0, 0, 0)",
                                 "lines": { "fill": true } },
                               { "series": { "shadowSize": 0 },
                                 "yaxis": { "min": 0, "max": "150" },
                                 "xaxis": { "min": 0, "max": 0, "mode": "time", "timeformat": "%H:%M" } },
                               1800000);




    var Data = new Values();

    Data.create("consumption_per_100km", "l/km", 2);
    Data.create("speed",  "km/h", 1);
    Data.create("consumption_average_timespan", "l/km", 2);
    Data.create("consumption_average_total", "l/km", 2);
    Data.create("consumption_per_h", "l/h", 2);
    Data.create("rpm", "rpm", 0);
    Data.create("temp_engine", "°C", 1);
    Data.create("temp_air_intake", "°C", 1);
    Data.create("voltage", "°C", 1);

});
  </script>

 </head>
  <body>
    <div class="left-container">
      <div id="graph-consumption" class="graph"></div>
   </div>

     <div class="right-container">
       <span id="consumption_per_100km" class="value value-big">-</span><span id="consumption_per_100km-unit" class="unit unit-big">l/km</span>
       <span id="speed" class="value value-big">-</span><span class="unit unit-big">km/h</span>

       <span id="consumption_average_timespan" class="value value-medium" style="margin-top:10px">-</span><span class="unit unit-medium" style="margin-top:20px">l/km</span>
       <span id="consumption_average_total" class="value value-medium">-</span><span class="unit unit-medium">l/km</span>
     </div>

   <div class="left-container">
      <div id="graph-speed" class="graph"></div>
  </div>

     <div class="right-container">
       <span id="consumption_per_h" class="value value-small">-</span><span class="unit unit-small">l/h</span>
       <span id="rpm" class="value value-small">-</span><span class="unit unit-small">rpm</span>
       <span id="temp_engine" class="value value-small">-</span><span class="unit unit-small">°C</span>
       <span id="temp_air_intake" class="value value-small">-</span><span class="unit unit-small">°C</span>
       <span id="voltage" class="value value-small">-</span><span class="unit unit-small">V</span>
     </div>

    </div>
 </body>
</html>

