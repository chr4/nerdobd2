<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>nerdobd2</title>
  <script language="javascript" type="text/javascript" src="js/jquery.min.js"></script>
  <script language="javascript" type="text/javascript" src="js/jquery.flot.min.js"></script>

 </head>
  <body>
    <div id="graphs">
      <div id="graph_consumption" style="width:470px;height:150px"></div>
      <div id="graph_speed" style="width:470px;height:150px"></div>
    </div>

    <div id="data" style="position:fixed;top:0px;left:500px;float:right;font-size:48px">
      <div id="rpm"></div>
      <div id="speed"></div>
      <div id="per_km"></div>
      <div id="timespan"></div>
      <div id="timespan_new"></div>
      <div id="total"></div>
      <div id="total_new"></div>      
    </div>

<script type="text/javascript">
$(function () {

    var index_consumption = 0;
    var index_speed = 0;

    var timespan_consumption = 300000; // 5min
    var timespan_speed = 1800000; // 30min

    var data_consumption = [];
    var data_speed = [];

    /* if timespan changes, only change it in JS, and reset index to 0 */

    function getData() {

        function onDataReceived(json) {
            var now = (new Date()).getTime();

            if (json.graph_consumption.index)
                index_consumption = json.graph_consumption.index;
            if (json.graph_speed.index)
                index_speed = json.graph_speed.index;           

            // remove data that is older than timespan first
            
            // loop reverse, for better performance
            for (i = data_consumption.length - 1; i >= 0; i--)
            {
                // after we find the first element that is outdated
                // remove everything up to this element
                if (data_consumption[i][0] < now - timespan_consumption)
                    data_consumption.splice(0, i + 1);
            }
            
            for (i = data_speed.length - 1; i >= 0; i--)
            {
                if (data_speed[i][0] < now - timespan_speed)
                    data_speed.splice(0, i + 1);
            }            
                        
            data_consumption = data_consumption.concat(json.graph_consumption.data);
            data_speed = data_speed.concat(json.graph_speed.data);

            var options_consumption = {
                // drawing is faster without shadows
                "series": { "shadowSize": 0 },
                "yaxis": { "min": 0, "max": "20" },
                "xaxis": { "min": now - timespan_consumption,
                           "max": now - 1000,
                           "mode": "time",
                           "timeformat": "%H:%M"
                },
            };
            var graph_consumption = {
                "data": data_consumption,
                "color": "rgb(30, 180, 20)",
                "lines": { "fill": true },
            };

            var options_speed = {
                // drawing is faster without shadows
                "series": { "shadowSize": 0 },
                "yaxis": { "min": 0, "max": "160" },
                "xaxis": { "min": now - timespan_speed,
                           "max": now - 1000,
                           "mode": "time",
                           "timeformat": "%H:%M"
                }
            };
            var graph_speed = {
                "data": data_speed,
                "color": "rgb(0, 0, 0)",
                "lines": { "fill": true }
            };

            if (json.latest_data.rpm)
                $("#rpm").html(json.latest_data.rpm.toFixed(0) + " rpm");
            if (json.latest_data.speed)
                $("#speed").html(json.latest_data.speed.toFixed(1) + " km/h");
            if (json.latest_data.per_km)
                $("#per_km").html(json.latest_data.per_km.toFixed(2) + " l/km");
            if (json.averages.timespan)
                $("#timespan").html(json.averages.timespan.toFixed(2) + " old");
            if (json.averages.timespan_new)
                $("#timespan_new").html(json.averages.timespan_new.toFixed(2) + " new");
            if (json.averages.total)
                $("#total").html(json.averages.total.toFixed(2) + " old");
            if (json.averages.total_new)
                $("#total_new").html(json.averages.total_new.toFixed(2) + " new");

            $.plot($("#graph_consumption"), [ graph_consumption ], options_consumption);
            $.plot($("#graph_speed"), [ graph_speed ], options_speed);
            
            setTimeout(getData, 500);
        }

        $.ajax({
            url: "data.json" + 
                 "?consumption_index=" + index_consumption +
                 "&consumption_timespan=" + timespan_consumption / 1000 + 
                 "&speed_index=" + index_speed + 
                 "&speed_timespan=" + timespan_speed / 1000,
            method: 'GET',
            dataType: 'json',
            success: onDataReceived
        });
    }

    getData();
});
</script>

 </body>
</html>

